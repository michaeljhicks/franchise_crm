<p style="color: green"><%= notice %></p>

<header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
  <div>
    <h1>Job for: <%= link_to @job.customer.business_name, @job.customer %></h1>
    <p>
      <strong>Type:</strong> <%= @job.job_type.humanize.titleize %> |
      <strong>Status:</strong> <%== status_badge(@job) %> |
      <strong>Scheduled for:</strong> <%= @job.scheduled_date_time ? @job.scheduled_date_time.strftime("%a, %b %d, %Y") : 'Not Scheduled' %>
    </p>
  </div>
  
  <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
    <%= link_to "Edit Job", edit_customer_machine_job_path(@customer, @machine, @job), class: "secondary header-button" %>
    
    <% unless @job.completed? || @job.cancelled? %>
      <%= button_to "Mark as Completed", complete_job_path(@job), 
            method: :patch, 
            class: "header-button",
            data: { turbo_confirm: "Are you sure?" } 
      %>
    <% end %>
  </div>
</header>

<%= form_with(model: @job, url: customer_machine_job_path(@customer, @machine, @job)) do |form| %>
  <article>
    <header><strong>Job Details & Checklist</strong></header>

    <% if @job.tasks.any? %>
      <h4>Checklist</h4>
      <%= form.fields_for :tasks do |task_form| %>
        <div style="display: flex; align-items: center; gap: 1rem; text-decoration: <%= task_form.object.completed_at? ? 'line-through' : 'none' %>; color: <%= task_form.object.completed_at? ? '#6B7280' : 'inherit' %>;">
          <%= task_form.check_box :completed %>
          <%= task_form.label :completed, task_form.object.description, style: "margin-bottom: 0;" %>
        </div>
        <hr>
      <% end %>
    <% else %>
      <p>No checklist items for this job type.</p>
    <% end %>

    <div class="grid" style="margin-top: 2rem;">
      <div>
        <%= form.label :contractor_notes, "External Notes (Visible to Customer)" %>
        <%= form.text_area :contractor_notes, rows: 5 %>
      </div>
      <div>
        <%= form.label :internal_notes, "Internal Notes (Team Only)" %>
        <%= form.text_area :internal_notes, rows: 5 %>
      </div>
    </div>
    
  </article>

  <div style="margin-top: 1rem;">
    <%= form.submit "Update Job Details" %>
  </div>
<% end %>

<br>

<div>
  <%= link_to "Back to all jobs", jobs_path %>

  <div style="margin-top: 2rem;">
    <%= button_to "Destroy This Job", 
                  [@customer, @machine, @job], 
                  method: :delete, 
                  form: { data: { turbo_confirm: "Are you sure you want to permanently delete this job?" } },
                  class: "contrast"
    %>
  </div>
</div>

<style>
  .header-button {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
    box-sizing: border-box; 
    white-space: nowrap; 
    display: inline-flex;
    align-items: center;
  }
</style>