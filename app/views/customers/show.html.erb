<p style="color: green"><%= notice %></p>

<header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <div>
    <h1><%= @customer.business_name %></h1>
    <p><%= @customer.street_address %>, <%= @customer.city %>, <%= @customer.state %> <%= @customer.zip %></p>
  </div>
  <div>
    <%= link_to "Edit Customer", edit_customer_path(@customer), role: "button", class: "secondary" %>

  </div>
</header>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start;">
  
  <div class="left-column">
    
    <article>
      <header style="display: flex; justify-content: space-between; align-items: center;">
        <strong>Equipment / Machines</strong>
        <%= link_to "+ New Machine", new_customer_machine_path(@customer), role: "button", class: "outline" %>
      </header>
      <% if @customer.machines.any? %>
        <% @customer.machines.each do |machine| %>
          <p>
            <strong><%= machine.machine_make %> <%= machine.machine_model %></strong><br>
            <small>Serial: <%= machine.machine_serial_number %> | Status: <%= machine.status %></small><br>
            <%= link_to "View Details", customer_machine_path(@customer, machine) %>
          </p>
          <hr>
        <% end %>
      <% else %>
        <p>No machines have been added for this customer yet.</p>
      <% end %>
    </article>

    <article>
      <header>
        <strong>All Jobs for this Customer</strong>
      </header>
      <% if @customer.jobs.any? %>
        <table>
          <thead>
            <tr>
              <th>Machine</th>
              <th>Scheduled For</th>
              <th>Type</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @customer.jobs.order(scheduled_date_time: :desc).each do |job| %>
              <tr>
                <td><%= link_to job.machine.machine_model, customer_machine_path(job.customer, job.machine) %></td>
                <td><%= job.scheduled_date_time ? job.scheduled_date_time.strftime("%b %d, %Y") : "Not Scheduled" %></td>
                <td><%= job.job_type.humanize.titleize %></td>
                <td><%== status_badge(job) %></td>
                <td>
                  <%= link_to "View Details", customer_machine_job_path(job.customer, job.machine, job), class: "secondary outline" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p>No jobs have been scheduled for this customer yet.</p>
      <% end %>
    </article>

    <article>
      <header><strong>Client Communications</strong></header>

      <%# First, check if the user is even connected to Google %>
      <% if current_user.google_access_token.present? %>
        
        <%# Second, check if any communications were actually found by the controller %>
        <% if @communications.any? %>
          <ul>
            <% @communications.each do |message| %>
              <%
                subject = message.payload.headers.find { |h| h.name == 'Subject' }&.value || "No Subject"
                date_str = message.payload.headers.find { |h| h.name == 'Date' }&.value
                gmail_link = "https://mail.google.com/mail/u/0/#inbox/#{message.id}"
              %>
              <li>
                <%= turbo_frame_tag "communication_#{message.id}" do %>
                  <%= link_to subject, communication_path(message.id), style: "font-weight: bold;" %><br>
                  <small><%= Time.parse(date_str).strftime("%b %d, %Y at %l:%M %P") if date_str %></small>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% else %>
          <%# This is the message for when the API search returns no results %>
          <p>No recent communications found for this customer's contacts.</p>
        <% end %>

      <% else %>
        <%# This is the message for when the user hasn't connected to Google yet %>
        <p>Connect your Google Account to see communication history.</p>
      <% end %>

    </article>
  </div>

  <div class="right-column">

    <article>
      <header><strong>Contact Info</strong></header>
      <% if @customer.contacts.any? %>
        <table>
          <thead>
            <tr><th>Name</th><th>Role</th><th>Phone</th><th>Email</th></tr>
          </thead>
          <tbody>
          <% @customer.contacts.each do |contact| %>
            <tr>
              <td><%= contact.name %></td>
              <td><%= contact.role %></td>
              <td><%= contact.phone %></td>
              <td><%= contact.email %></td>
            </tr>
          <% end %>
          </tbody>
        </table>
      <% else %>
        <p>No contacts found.</p>
      <% end %>
    </article>

     <article>
      <header style="display: flex; justify-content: space-between; align-items: center;">
        <strong>Lease Agreements</strong>
        <%= link_to "+ New Lease", new_lease_agreement_path(customer_id: @customer.id), role: "button", class: "outline" %>
      </header>
      <% if @customer.lease_agreements.any? %>
        <% @customer.lease_agreements.order(lease_start_date: :desc).each do |lease| %>
          <p>
            <%= number_to_currency(lease.lease_rate) %> / mo<br>
            <small>Ends: <%= lease.lease_end_date&.strftime("%b %d, %Y") || 'Active' %></small><br>
            <%= link_to "View Details", lease %>
          </p>
          <hr>
        <% end %>
      <% else %>
        <p>No lease agreements found for this customer.</p>
      <% end %>
    </article>

    <article>
      <header><strong>Notes</strong></header>
      <p><%= @customer.notes %></p>
    </article>

    
    <div>
      <%= button_to "Destroy", @customer, 
                    method: :delete, 
                    form: { data: { turbo_confirm: "Are you sure? This will delete the customer AND all associated machines and jobs." } },
                    class: "contrast"
      %>
    </div>

  </div>
</div>